---
title: M贸dulo Sqlite3
author: enidev911
categories: [Python, M贸dulos]
mermaid: true
pin: true
tags: [m贸dulos]
image:
    path: /assets/img/posters/python-sqlite3.png
    alt: "DB-API 2.0 es un est谩ndar definido por Python"
---

Python DB-API es un conjunto de est谩ndares recomendados por un grupo de inter茅s especial para la estandarizaci贸n de m贸dulos de base de datos. Los est谩ndares DB-API se modificaron a煤n m谩s en DB-API 2.0 mediante otra propuesta de mejora que se espec铆fica en el [PEP-249](https://peps.python.org/pep-0249/){: target='_blank' }

Seg煤n los est谩ndares prescritos, el primer paso del proceso es obtener la conexi贸n con el objeto que representa la base de datos.

## Conexi贸n a una Base De Datos

Para establecer una conexi贸n con la base de datos SQLite, es necesario importar el m贸dulo sqlite3 y ejecutar el m茅todo `connect()`:

```python
import sqlite3

db_connection = sqlite3.connect("university.db")
```
{: .nolineno }


### M茅todos de un objeto Conexi贸n

El m茅todo `connect()` devuelve un objeto de conexi贸n que hace referencia a la base de datos existente o una nueva base de datos si no existe.

Los siguientes m茅todos del objeto conexi贸n son 煤tiles:

|M茅todo|Descripci贸n|
|:-----|:----------|
|`cursor()`|Devuelve un objeto cursor que usa esta conexi贸n.|
|`commit()`|Compromete expl铆citamente cualquier transacci贸n pendiente a la base de datos.|
|`rollback()`|Este m茅todo opcional hace que una transacci贸n se retrotraiga al punto de partida.|
|`close()`|Cierra la conexi贸n a la base de datos de forma permanente.|

Los m茅todos `commit()` y `rollback()` del objeto de conexi贸n garantizan el control de transacciones. Ejemplo:

```python
import sqlite3

db = sqlite3.connect("university.db")
try:
  db.execute("Query")
  db.commit()
else:
  print("Error")
  db.rollback()
db.close()
```
{: .nolineno }


## Crear un Cursor

Un cursor es un objeto de Python que le permite trabajar con la base de datos, act煤a como un identificador para una consulta SQL determinada; permite la recuperaci贸n de una o m谩s filas del resultado. Para crear un cursor utilizamos el objeto de conexi贸n de la siguiente forma:

```python
import sqlite3

db_connection = sqlite3.connect('university.db')
cursor = db_connection.cursor()
```
{: .nolineno }


### M茅todos de un objeto Cursor

Los siguientes m茅todos del objeto cursor son 煤tiles:

|M茅todo|Descripci贸n|
|:-----|:----------|
|`execute()`|Ejecuta la consulta SQL como par谩metro de cadena.|
|`executemany()`|Ejecuta la consulta SQL usando un conjunto de par谩metros en la lista de tuplas.|
|`fetchone`|Obtiene la siguiente fila del conjunto de resultado de la consulta.|
|`fetchall()`|Obtiene todas las filas restante del conjunto de resultados de la consulta.|
|`close()`|Cierra el objeto cursor.|

#### Crear una tabla

Una cadena que encierra la consulta `CREATE TABLE` se pasa como par谩metros al m茅todo `execute()` del objeto cursor. El siguiente c贸digo crea las tabla students en la base de datos **university.db**:

```python
import sqlite3
db = sqlite3.connect('university.db')
try:
  cur = db.cursor()
  cur.execute('''
    CREATE TABLE students(
      ID INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT(30) NOT NULL,
      age INTEGER,
      note REAL);
  ''')
  print('Table created successfully')
except:
  print('Error in operation')
  db.rollback()
db.close() 
```

### Insertar un registro

Ya que tenemos una tabla, podemos usar nuevamente el m茅todo `execute()` del objeto cursor con un argumento de cadena que represente la consulta `INSERT` . Ejemplo:

```python
qry = "INSERT INTO students (name, age, note) VALUES ('john', 33, 6.5);"
```
{: .nolineno }

Ahora la cadena anterior, debemos usarla como par谩metro del m茅todo `execute`:

```python
cursor.execute(qry)
```
{: .nolineno }


### CRUD


Ahora vamos hacer un CRUD completo, para que tengamos una aplicaci贸n de consola. 驴Entretenido? き

Para facilitarnos la existencia, vamos a modularizar el c贸digo, comenzando por tener en un archivo `db.py` lo relacionado con la creaci贸n y configuraci贸n de la base de datos:

```python
import sqlite3
from sqlite3 import Error
import os

CURDIR = os.path.dirname(os.path.abspath(__file__))
FILENAME = "schema.sql"
FILE = os.path.join(CURDIR, "db", FILENAME)

def open_db():
    try:
        con = sqlite3.connect('cars.db')
        return con
    except Error as e:
        print('Error: ', e)

def run_query(sql, params='', multiple=False):

    with open_db() as con:
        cursor = con.cursor()
        try:
            if multiple:
                return cursor.executemany(sql, params)
            else:
                return cursor.execute(sql, params)
        except Error as e:
            print('Error: ', e)

def create_schema():
    with open(FILE, 'r') as sql_file:
        sql_script = sql_file.read()
        schema_created = run_query(sql_script)
        if schema_created.rowcount == -1:
            print("Database created successfully")

if __name__ == "__main__":
    create_schema()
```
{: file="db.py" }


Vamos a resumir que hace el c贸digo anterior, sobretodo las funciones:

**`open_db`**
: Se encargar谩 de crear o abrir la base de datos y se maneja a trav茅s `try/except` para capturar posibles errores.

**`run_query`**
: Esta funci贸n va a utilizar la conexi贸n que retorna `open_db` y con ella podemos realizar consultas a la base de datos.

**`create_schema()`**
: Esta funci贸n va a construir el esquema de la base de datos que tenemos definido en un archivo llamado `schema.sql`.


#### Insertar Datos

Para comenzar con las operaciones del CRUD, en un archivo `crud.py` definiremos las funciones de las 4 operaciones:

```python
import db

def insert_data():
  insert_query = "INSERT INTO cars (brand, model) VALUES(?, ?)"
  cars_data = [
      ('Chevrolet', 'Chevrolet Camaro'),
      ('Chevrolet', 'Chevrolet Captiva'),
      ('Fiat', 'Fiat 125 Mirafiori'),
      ('Fiat', 'Fiat 125 Centurion'),
      ('Honda', 'Honda CR-V'),
      ('Honda', 'Honda CR-X del Sol'),
      ('Honda', 'Honda CR-Z')
  ]

  result = db.run_query(insert_query, cars_data, True)
  print("Record inserted successfully into table", result.rowcount)
```

